# Init commands to run when agent shell starts
mise trust

# Change to the worktree directory
cd "$BOTSTER_WORKTREE_PATH"

# Use the task description directly as the prompt (it's already complete)
BOTSTER_PROMPT="$BOTSTER_TASK_DESCRIPTION"

# Auto-trust the worktree in Claude config using botster-hub's JSON tools
"$BOTSTER_HUB_BIN" json-set ~/.claude.json "projects.$BOTSTER_WORKTREE_PATH.hasTrustDialogAccepted" "true"

# Register trybotster MCP server for this worktree (if token is available)
if [ -n "$BOTSTER_TOKEN" ]; then
  echo "Registering trybotster MCP server..."
  claude mcp add trybotster \
    --transport http \
    https://mcp-dev.trybotster.com \
    --header \
    "Authorization: Bearer `echo $BOTSTER_TOKEN`"
fi

if [ "$BOTSTER_ISSUE_NUMBER" != "0" ]; then
  echo "Botster agent initialized for issue #$BOTSTER_ISSUE_NUMBER"
else
  echo "Botster agent initialized for branch: $BOTSTER_BRANCH_NAME"
fi
echo "Worktree: $BOTSTER_WORKTREE_PATH"

# Start Claude with the prompt
claude --permission-mode acceptEdits "$BOTSTER_PROMPT"

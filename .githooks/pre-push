#!/usr/bin/env bash

# Pre-push hook: Runs rubocop and brakeman before allowing push
# To enable: git config core.hooksPath .githooks

set -e

echo "Running pre-push checks..."

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
FAILED=0

# Run Rubocop
echo -e "\n${YELLOW}Running Rubocop...${NC}"
if bundle exec rubocop --parallel; then
    echo -e "${GREEN}Rubocop passed!${NC}"
else
    echo -e "${RED}Rubocop failed!${NC}"
    FAILED=1
fi

# Run Brakeman
echo -e "\n${YELLOW}Running Brakeman...${NC}"
if bundle exec brakeman --quiet --no-pager; then
    echo -e "${GREEN}Brakeman passed!${NC}"
else
    echo -e "${RED}Brakeman failed!${NC}"
    FAILED=1
fi

# Exit with failure if any check failed
if [ $FAILED -ne 0 ]; then
    echo -e "\n${RED}Pre-push checks failed! Please fix the issues before pushing.${NC}"
    echo -e "${YELLOW}To bypass this check (not recommended): git push --no-verify${NC}"
    exit 1
fi

echo -e "\n${GREEN}All pre-push checks passed!${NC}"
exit 0

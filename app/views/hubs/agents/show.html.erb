<% content_for :head do %>
  <%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css" %>
<% end %>

<%#
  Agent Terminal View

  Controllers:
  - terminal-display: xterm.js rendering, acquires TerminalConnection via ConnectionManager
  - hub-status: Connection state (CSS-driven)
  - terminal-status: Terminal connection state (CSS-driven)
  - terminal-header: Tab switching, preview link
  - agent-list: Sidebar agent list (uses template)
%>

<%# Main terminal view %>
<div class="h-full flex flex-col overflow-hidden"
     data-controller="terminal-display"
     data-terminal-display-hub-id-value="<%= Current.hub.id %>"
     data-terminal-display-agent-index-value="<%= Current.agent_index %>"
     data-terminal-display-pty-index-value="<%= Current.pty_index %>">

  <%# Header %>
  <div class="shrink-0 border-b border-zinc-800 bg-zinc-900/50">
    <%# Mobile header - compact %>
    <div class="lg:hidden px-3 py-2">
      <div class="flex items-center justify-between gap-2">
        <%# Hub status indicator + agent dropdown %>
        <div class="flex items-center gap-2 min-w-0"
             data-controller="hub-status"
             data-hub-status-hub-id-value="<%= Current.hub.id %>"
             data-hub-status-state-value="disconnected"
             class="group">

          <%# Status icon - CSS driven %>
          <span class="shrink-0">
            <%# Disconnected %>
            <span class="hidden group-data-[hub-status-state-value=disconnected]:block">
              <%= icon "signal-slash", class: "size-3 text-zinc-500" %>
            </span>
            <%# Loading/Connecting %>
            <span class="hidden group-data-[hub-status-state-value=loading]:block group-data-[hub-status-state-value=connecting]:block group-data-[hub-status-state-value=handshake]:block">
              <%= icon "arrow-path", class: "size-3 text-cyan-400 animate-spin" %>
            </span>
            <%# Connected %>
            <span class="hidden group-data-[hub-status-state-value=connected]:block">
              <%= icon "lock-closed", variant: :solid, class: "size-3 text-emerald-400" %>
            </span>
            <%# Error %>
            <span class="hidden group-data-[hub-status-state-value=error]:block">
              <%= icon "exclamation-circle", class: "size-3 text-red-400" %>
            </span>
          </span>

          <%# Hub/Agent label %>
          <span class="text-sm font-mono text-zinc-300 truncate">
            <%= Current.hub.device&.name || Current.hub.identifier.truncate(16) %>
          </span>
        </div>

        <%# Mobile status text %>
        <div data-controller="hub-status"
             data-hub-status-hub-id-value="<%= Current.hub.id %>"
             data-hub-status-state-value="disconnected"
             class="group text-xs shrink-0">
          <span class="hidden group-data-[hub-status-state-value=disconnected]:inline text-zinc-500">Offline</span>
          <span class="hidden group-data-[hub-status-state-value=loading]:inline group-data-[hub-status-state-value=connecting]:inline text-zinc-500">Connecting...</span>
          <span class="hidden group-data-[hub-status-state-value=handshake]:inline text-amber-400">Waiting for CLI...</span>
          <span class="hidden group-data-[hub-status-state-value=connected]:inline text-emerald-400">Connected</span>
          <span class="hidden group-data-[hub-status-state-value=error]:inline text-red-400">Error</span>
        </div>
      </div>
    </div>

    <%# Desktop header - full %>
    <div class="hidden lg:block px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4 min-w-0">
          <div class="min-w-0">
            <h1 class="text-lg font-bold text-zinc-100 font-mono truncate">
              <%= Current.hub.device&.name || Current.hub.identifier.truncate(24) %>
            </h1>
            <p class="text-xs text-zinc-500 truncate">
              <%= Current.hub.repo || "No repository" %>
            </p>
          </div>
        </div>

        <%# Connection status - CSS driven %>
        <div data-controller="hub-status"
             data-hub-status-hub-id-value="<%= Current.hub.id %>"
             data-hub-status-state-value="disconnected"
             class="group flex items-center gap-2 shrink-0">

          <%# Status indicator %>
          <div class="flex items-center gap-2 text-sm font-medium">
            <%# Disconnected %>
            <span class="hidden group-data-[hub-status-state-value=disconnected]:flex items-center gap-2 text-zinc-500">
              <%= icon "signal-slash", class: "size-4" %>
              <span>Disconnected</span>
            </span>

            <%# Loading %>
            <span class="hidden group-data-[hub-status-state-value=loading]:flex items-center gap-2 text-cyan-400">
              <%= icon "arrow-path", class: "size-4 animate-spin" %>
              <span class="text-zinc-400">Loading...</span>
            </span>

            <%# Connecting %>
            <span class="hidden group-data-[hub-status-state-value=connecting]:flex items-center gap-2 text-cyan-400">
              <%= icon "arrow-path", class: "size-4 animate-spin" %>
              <span class="text-zinc-400">Connecting...</span>
            </span>

            <%# Handshake %>
            <span class="hidden group-data-[hub-status-state-value=handshake]:flex items-center gap-2 text-amber-400">
              <%= icon "arrow-path", class: "size-4 animate-spin" %>
              <span>Waiting for CLI...</span>
            </span>

            <%# Connected %>
            <span class="hidden group-data-[hub-status-state-value=connected]:flex items-center gap-2 text-emerald-400">
              <%= icon "lock-closed", variant: :solid, class: "size-4" %>
              <span>Connected</span>
            </span>

            <%# Error %>
            <span class="hidden group-data-[hub-status-state-value=error]:flex items-center gap-2 text-red-400">
              <%= icon "exclamation-circle", class: "size-4" %>
              <span>Connection failed</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# Terminal Panel %>
  <div class="flex-1 min-h-0 flex flex-col"
       data-controller="terminal-header"
       data-terminal-header-hub-id-value="<%= Current.hub.id %>"
       data-terminal-header-agent-index-value="<%= Current.agent_index %>"
       data-terminal-header-tunnel-connected-value="false"
       class="group/terminal">

    <div class="flex-1 flex flex-col min-h-0 bg-zinc-950 overflow-hidden">
      <%# Terminal header bar %>
      <div class="shrink-0 px-2 lg:px-4 py-1.5 lg:py-2 border-b border-zinc-800 flex items-center justify-between bg-zinc-900">
        <div class="flex items-center gap-2 lg:gap-3">
          <%# Traffic lights - desktop only %>
          <div class="hidden lg:flex items-center gap-1.5">
            <span class="size-3 rounded-full bg-red-500/80"></span>
            <span class="size-3 rounded-full bg-yellow-500/80"></span>
            <span class="size-3 rounded-full bg-green-500/80"></span>
          </div>

          <%# PTY switcher tabs %>
          <div class="flex items-center bg-zinc-800/50 rounded p-0.5">
            <%= link_to hub_agent_pty_path(Current.hub, Current.agent_index, 0),
                        class: "px-2 py-1 text-xs font-medium rounded transition-colors #{Current.pty_index == 0 ? 'bg-zinc-700 text-zinc-100' : 'text-zinc-500 hover:text-zinc-300'}",
                        data: { turbo_action: "replace" } do %>
              <span class="hidden sm:inline">Agent</span>
              <span class="sm:hidden">CLI</span>
            <% end %>
            <%= link_to hub_agent_pty_path(Current.hub, Current.agent_index, 1),
                        class: "px-2 py-1 text-xs font-medium rounded transition-colors #{Current.pty_index == 1 ? 'bg-zinc-700 text-zinc-100' : 'text-zinc-500 hover:text-zinc-300'}",
                        data: { turbo_action: "replace" } do %>
              Server
            <% end %>
          </div>
        </div>

        <div class="flex items-center gap-2 lg:gap-3">
          <%# Preview link - shown when tunnel is connected (CSS driven) %>
          <a href="#"
             data-terminal-header-target="previewLink"
             class="hidden group-data-[terminal-header-tunnel-connected-value=true]/terminal:inline-flex items-center gap-1.5 px-2 py-1 text-xs font-medium bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500/30 rounded transition-colors">
            <%= icon "arrow-top-right-on-square", class: "size-3" %>
            <span class="hidden sm:inline">Preview</span>
          </a>

          <span class="text-xs text-zinc-600 hidden lg:inline">scroll: mouse wheel</span>

          <%# Terminal encryption badge - CSS driven via terminal-status %>
          <div data-controller="terminal-status"
               data-terminal-status-hub-id-value="<%= Current.hub.id %>"
               data-terminal-status-agent-index-value="<%= Current.agent_index %>"
               data-terminal-status-pty-index-value="<%= Current.pty_index %>"
               data-terminal-status-state-value="disconnected"
               class="group/badge">
            <%# Connecting %>
            <span class="hidden group-data-[terminal-status-state-value=disconnected]/badge:inline-flex group-data-[terminal-status-state-value=loading]/badge:inline-flex group-data-[terminal-status-state-value=connecting]/badge:inline-flex items-center gap-1 px-1.5 lg:px-2 py-0.5 text-xs font-medium bg-zinc-700/50 text-zinc-500 rounded">
              <%= icon "lock-open", class: "size-3" %>
              <span class="hidden sm:inline">Connecting...</span>
            </span>
            <%# Connected %>
            <span class="hidden group-data-[terminal-status-state-value=connected]/badge:inline-flex items-center gap-1 px-1.5 lg:px-2 py-0.5 text-xs font-medium bg-emerald-500/10 text-emerald-400 rounded">
              <%= icon "lock-closed", variant: :solid, class: "size-3" %>
              <span class="hidden sm:inline">E2E Encrypted</span>
            </span>
            <%# Error %>
            <span class="hidden group-data-[terminal-status-state-value=error]/badge:inline-flex items-center gap-1 px-1.5 lg:px-2 py-0.5 text-xs font-medium bg-red-500/10 text-red-400 rounded">
              <%= icon "exclamation-triangle", class: "size-3" %>
              <span class="hidden sm:inline">Error</span>
            </span>
          </div>
        </div>
      </div>

      <%# Terminal content %>
      <div data-terminal-display-target="container" class="terminal-container flex-1 min-h-0 bg-zinc-950"></div>
    </div>
  </div>

  <%# Mobile Touch Controls %>
  <div class="shrink-0 lg:hidden border-t border-zinc-800 bg-zinc-900 touch-controls-container"
       data-controller="keyboard-viewport">
    <div class="flex gap-1.5 px-2 py-2 overflow-x-auto scrollbar-none">
      <%# Primary keys %>
      <%= render Elements::ButtonComponent.new("^C", color: :neutral, variant: :soft, size: :sm, class: "shrink-0 font-mono", data: { action: "terminal-display#sendCtrlC" }) %>
      <%= render Elements::ButtonComponent.new("Enter", color: :neutral, variant: :soft, size: :sm, class: "shrink-0", data: { action: "terminal-display#sendEnter" }) %>
      <%= render Elements::ButtonComponent.new("Tab", color: :neutral, variant: :soft, size: :sm, class: "shrink-0", data: { action: "terminal-display#sendTab" }) %>
      <%= render Elements::ButtonComponent.new("Esc", color: :neutral, variant: :soft, size: :sm, class: "shrink-0", data: { action: "terminal-display#sendEscape" }) %>

      <%# Separator %>
      <div class="shrink-0 w-px bg-zinc-700 mx-0.5"></div>

      <%# Arrow keys %>
      <%= render Elements::ButtonComponent.new(color: :neutral, variant: :soft, size: :sm, class: "shrink-0", data: { action: "terminal-display#sendArrowUp" }) do %>
        <%= icon "chevron-up", class: "size-4" %>
      <% end %>
      <%= render Elements::ButtonComponent.new(color: :neutral, variant: :soft, size: :sm, class: "shrink-0", data: { action: "terminal-display#sendArrowDown" }) do %>
        <%= icon "chevron-down", class: "size-4" %>
      <% end %>
      <%= render Elements::ButtonComponent.new(color: :neutral, variant: :soft, size: :sm, class: "shrink-0", data: { action: "terminal-display#sendArrowLeft" }) do %>
        <%= icon "chevron-left", class: "size-4" %>
      <% end %>
      <%= render Elements::ButtonComponent.new(color: :neutral, variant: :soft, size: :sm, class: "shrink-0", data: { action: "terminal-display#sendArrowRight" }) do %>
        <%= icon "chevron-right", class: "size-4" %>
      <% end %>

      <div class="shrink-0 w-4"></div>
    </div>
  </div>
</div>

<div class="max-w-2xl mx-auto px-4 py-8"
     data-controller="notifications"
     data-notifications-page-value="true">

  <header class="mb-8">
    <h1 class="text-2xl font-bold text-zinc-100 mb-2">Notifications</h1>
    <p class="text-sm text-zinc-400">Push notifications and history — all stored locally on this device</p>
  </header>

  <%# Push notification management — per device %>
  <% if @cli_devices.any? %>
    <section class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 lg:p-6 mb-8">
      <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wider mb-4">Push Notifications</h2>

      <div class="space-y-3">
        <% @cli_devices.each do |device| %>
          <% active_hub = device.hubs.find(&:active?) %>
          <div class="flex items-center justify-between gap-4 bg-zinc-800/50 border border-zinc-700/50 rounded-lg px-4 py-3"
               data-controller="push-subscription"
               data-push-subscription-device-id-value="<%= device.id %>"
               data-push-subscription-hub-id-value="<%= active_hub&.id %>"
               data-push-subscription-enabled-value="<%= device.notifications_enabled? %>"
               data-push-subscription-sw-url-value="<%= pwa_service_worker_path %>"
               <% source_hub = @source_device&.hubs&.find(&:active?) if @source_device && @source_device != device %>
               <% if source_hub %>
                 data-push-subscription-source-hub-id-value="<%= source_hub.id %>"
               <% end %>>

            <div class="flex items-center gap-3 min-w-0">
              <div class="size-8 rounded-lg bg-zinc-700/50 flex items-center justify-center shrink-0">
                <%= icon "computer-desktop", class: "size-4 text-zinc-400" %>
              </div>
              <div class="min-w-0">
                <span class="text-sm font-medium text-zinc-200 truncate block"><%= device.name %></span>
                <span class="text-xs text-zinc-500">
                  <% if device.active? %>
                    <span class="inline-flex items-center gap-1">
                      <span class="size-1.5 rounded-full bg-success-500"></span>
                      Online
                    </span>
                  <% else %>
                    Offline
                  <% end %>
                </span>
              </div>
            </div>

            <div class="shrink-0 flex items-center gap-2">
              <span data-push-subscription-target="status"
                    class="text-xs text-zinc-500"></span>

              <%# All button variants — controller toggles visibility based on browser + CLI state %>

              <%# CLI has keys + browser subscribed %>
              <div data-push-subscription-target="subscribedButtons" class="hidden flex items-center gap-2">
                <% if active_hub %>
                  <button data-action="push-subscription#test"
                          class="text-xs px-3 py-1.5 text-zinc-400 hover:text-zinc-200 bg-zinc-800 hover:bg-zinc-800/80 border border-zinc-700/50 rounded-lg transition-colors">
                    Test
                  </button>
                <% end %>
                <button data-action="push-subscription#disable"
                        class="text-xs px-3 py-1.5 text-zinc-400 hover:text-red-400 bg-zinc-800 hover:bg-zinc-800/80 border border-zinc-700/50 rounded-lg transition-colors">
                  Disable
                </button>
              </div>

              <%# CLI has keys but browser NOT subscribed — subscribe this browser %>
              <div data-push-subscription-target="enableBrowserButtons" class="hidden">
                <button data-action="push-subscription#enableBrowser"
                        class="text-xs px-3 py-1.5 text-primary-300 hover:text-primary-200 bg-primary-500/10 hover:bg-primary-500/20 border border-primary-500/20 rounded-lg transition-colors">
                  Enable on this device
                </button>
              </div>

              <%# CLI has NO keys — full enable flow %>
              <div data-push-subscription-target="enableButtons" class="hidden">
                <% if active_hub.nil? %>
                  <button disabled
                          title="Device must be online to enable notifications"
                          class="text-xs px-3 py-1.5 text-zinc-600 bg-zinc-800/50 border border-zinc-700/30 rounded-lg cursor-not-allowed">
                    Enable
                  </button>
                <% elsif @source_device && @source_device != device %>
                  <button data-action="push-subscription#enable"
                          title="Keys will be copied from <%= @source_device.name %>"
                          class="text-xs px-3 py-1.5 text-primary-300 hover:text-primary-200 bg-primary-500/10 hover:bg-primary-500/20 border border-primary-500/20 rounded-lg transition-colors">
                    Enable
                  </button>
                <% else %>
                  <button data-action="push-subscription#enable"
                          class="text-xs px-3 py-1.5 text-primary-300 hover:text-primary-200 bg-primary-500/10 hover:bg-primary-500/20 border border-primary-500/20 rounded-lg transition-colors">
                    Enable
                  </button>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <% if @source_device %>
        <p class="text-xs text-zinc-500 mt-3">
          Notification keys from <strong class="text-zinc-400"><%= @source_device.name %></strong> will be shared with new devices.
        </p>
      <% end %>
    </section>
  <% end %>

  <%# Notification history %>
  <section class="bg-zinc-900/50 border border-zinc-800 rounded-lg overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-zinc-800">
      <h2 class="text-sm font-medium text-zinc-400 uppercase tracking-wider">History</h2>
      <button data-action="notifications#markAllRead"
              class="text-xs text-zinc-500 hover:text-zinc-300 transition-colors">
        Mark all read
      </button>
    </div>

    <%# Template for each notification item — cloned by Stimulus %>
    <template data-notifications-target="template">
      <article class="flex items-start gap-3 px-4 py-3 border-b border-zinc-800 transition-opacity"
               data-notification-id>
        <div class="shrink-0 mt-1">
          <div data-field="dot" class="size-2 rounded-full bg-primary-400"></div>
        </div>
        <div class="flex-1 min-w-0">
          <a data-field="link" href="#"
             class="text-sm text-zinc-200 hover:text-white block"></a>
          <time data-field="time" class="text-xs text-zinc-500"></time>
        </div>
        <button data-field="readBtn"
                data-action="notifications#markAsRead"
                class="shrink-0 text-xs text-zinc-500 hover:text-zinc-300">
          Mark read
        </button>
      </article>
    </template>

    <%# List container — populated from IndexedDB %>
    <div data-notifications-target="list"></div>

    <%# Empty state %>
    <p data-notifications-target="empty"
       class="hidden px-4 py-12 text-center text-sm text-zinc-500">
      No notifications yet
    </p>
  </section>
</div>

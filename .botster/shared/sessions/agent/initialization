# Init commands to run when agent shell starts
mise trust

# Change to the worktree directory
cd "$BOTSTER_WORKTREE_PATH"

# Helper to read values from .botster/context.json (worktrees only).
# Falls back to env vars when running on main (no context file).
botster_context() {
  local val
  val=$(botster json-get .botster/context.json "$1" 2>/dev/null | tr -d '"')
  echo "$val"
}

# Read task context â€” env vars take priority (set by hub at spawn time),
# fall back to context.json (worktrees) then legacy BOTSTER_TASK_DESCRIPTION.
BOTSTER_PROMPT="${BOTSTER_PROMPT:-$(botster_context "prompt")}"
BOTSTER_PROMPT="${BOTSTER_PROMPT:-$BOTSTER_TASK_DESCRIPTION}"

BOTSTER_ISSUE_NUMBER="${BOTSTER_ISSUE_NUMBER:-$(botster_context "issue_number")}"
BOTSTER_BRANCH_NAME="${BOTSTER_BRANCH_NAME:-$(botster_context "branch_name")}"

# Auto-trust the worktree in Claude config using botster's JSON tools
botster json-set ~/.claude.json "projects.$BOTSTER_WORKTREE_PATH.hasTrustDialogAccepted" "true"

# Note: We detect when Claude asks questions by scanning for UI patterns like
# "Enter to select" and "Tab/Arrow keys to navigate" in the terminal output.
# This works regardless of notification settings.

# Register trybotster MCP server for this worktree (if token is available)
if [ -n "$BOTSTER_MCP_TOKEN" ]; then
  echo "Registering trybotster MCP server..."
  claude mcp add trybotster \
    --transport http \
    https://mcp-dev.trybotster.com \
    --header \
    "Authorization: Bearer `echo $BOTSTER_MCP_TOKEN`"
fi

if [ "$BOTSTER_ISSUE_NUMBER" != "0" ]; then
  echo "Botster agent initialized for issue #$BOTSTER_ISSUE_NUMBER"
else
  echo "Botster agent initialized for branch: $BOTSTER_BRANCH_NAME"
fi
echo "Worktree: $BOTSTER_WORKTREE_PATH"

# Server is now spawned in a separate PTY by botster (Ctrl+T to toggle view)

# Start Claude with the prompt
claude --permission-mode acceptEdits "$BOTSTER_PROMPT"
